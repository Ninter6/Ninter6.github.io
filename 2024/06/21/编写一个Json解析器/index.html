<!DOCTYPE html><html lang="zh-CN" theme-mode="auto"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>编写一个JSON解析器「C++」 | 60Hz Viewing</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="preload" as="font" crossorigin="anonymous" href="/font/Bender.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/BenderLight.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/JetBrainsMono-Regular.woff2"><link rel="stylesheet" href="/css/arknights.css"><style>@font-face {
  font-family: Bender;
  src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
  font-family: BenderLight;
  src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
  font-family: 'JetBrains Mono';
  src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}
</style><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"copy"}}</script><link type="text/css" rel="stylesheet" href="/lib/encrypt/hbe.style.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><script>if (window.localStorage.getItem('theme-mode') === 'light' || window.matchMedia('(prefers-color-scheme:light)').matches)
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark' || window.matchMedia('(prefers-color-scheme:dark)').matches)
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>:root {
 --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
 --light-background: url('/img/bk.jpg');
 --theme-encrypt-confirm: 'confirm'
}</style><script defer src="/js/arknights.js"></script><script defer src="/js/search.js"></script><script defer type="module">import mermaid from '//unpkg.com/mermaid@10.5.0/dist/mermaid.esm.mjs';
window.mermaid = mermaid;
code.paintMermaid();
</script><script async src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script async src="/lib/encrypt/hbe.js"></script><script async src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js','data-pjax','.busuanzi'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><meta name="generator" content="Hexo 7.1.1"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup" tabindex="0"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>编写一个JSON解析器「C++」</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2024-06-21T15:10:54.000Z" id="date"> 2024-06-21</time></div></span><br><span>Last Update: <div class="control"><time datetime="2024-06-22T15:33:29.436Z" id="updated"> 2024-06-22</time></div></span></div></div><hr><div id="post-content"><h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1>
<ul>
<li><ol start="0" type="1">
<li><a href="#简介">简介</a></li>
</ol></li>
<li><ol type="1">
<li><a href="#什么是json">什么是JSON</a></li>
</ol>
<ul>
<li>1.1 <a href="#json的基本数据类型">JSON的基本数据类型</a></li>
<li>1.2 <a href="#json中的token">JSON中的token</a></li>
</ul></li>
<li><ol start="2" type="1">
<li><a href="#封装一个json容器">封装一个JSON容器</a></li>
</ol>
<ul>
<li>2.1 <a href="#数据存储">数据存储</a></li>
<li>2.2 <a href="#包装">包装</a></li>
</ul></li>
<li><ol start="3" type="1">
<li><a href="#实现json解析器">实现JSON解析器</a></li>
</ol>
<ul>
<li>3.1 <a href="#jsonscanner">JsonScanner</a></li>
<li>3.2 <a href="#jsonparser">JsonParser</a></li>
</ul></li>
</ul>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1>
<blockquote>
<p>本站主打“<em>一文通</em>”</p>
</blockquote>
<p>之前打磨了一下自己的工具库，这个JSON解析器算少数几个还能用的，索性重写了一下。现在自我感觉良好，所以分享一下。</p>
<h1 id="什么是json"><a href="#什么是json" class="headerlink" title="什么是json"></a>什么是JSON</h1>
<p>JSON作为一种轻量级资料交换格式，具有易于阅读和处理的优势。</p>
<h2 id="json的基本数据类型"><a href="#json的基本数据类型" class="headerlink" title="json的基本数据类型"></a>JSON的基本数据类型</h2>
<ul>
<li>数值: 不区分整数与浮点数，用双精度浮点数表示所有数值。</li>
<li>字符串:
以双引号<code>""</code>括起来的零个或多个Unicode码位。支持反斜杠开始的转义字符序列。</li>
<li>布尔值：表示为<code>true</code>或者<code>false</code>。</li>
<li>数组：有序的零个或者多个值。每个值可以为任意类型。数组使用方括号[]包裹。多个数组元素之间用逗号,分隔，形如：<code>[value, value]</code>。</li>
<li>对象：若干无序的“键-值对”(key-value
pairs)，其中键只能是字符串。建议但不强制要求对象中的键是独一无二的。对象以花括号<code>{}</code>包裹。多个键-值对之间使用逗号<code>,</code>分隔。键与值之间用冒号<code>:</code>分隔。</li>
<li>空值：值写为<code>null</code>。</li>
</ul>
<h2 id="json中的token"><a href="#json中的token" class="headerlink" title="json中的token"></a>JSON中的token</h2>
<ul>
<li>6种标点符号: <code>{}</code> <code>[]</code> <code>,</code>
<code>:</code></li>
<li>3种字面量: <code>false</code> <code>true</code>
<code>null</code></li>
<li>字符串</li>
<li>数值</li>
</ul>
<p>除此之外，四个特定字符被认为是空白符：空格符、水平制表符、回车符、换行符。JSON标准不允许有字节序掩码，不提供注释的句法。</p>
<h1 id="封装一个json容器"><a href="#封装一个json容器" class="headerlink" title="封装一个json容器"></a>封装一个JSON容器</h1>
<p>了解了JSON的基本语法后就可以着手实现解析器了。让我们先从JSON容器开始。</p>
<h2 id="数据存储"><a href="#数据存储" class="headerlink" title="数据存储"></a>数据存储</h2>
<p>首先明确我们存储JSON数据的底层类型。<br>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Json</span>;<br><br><span class="hljs-keyword">using</span> JsonObject = std::unordered_map&lt;std::string, Json&gt;;<br><span class="hljs-keyword">using</span> JsonArray = std::vector&lt;Json&gt;;<br><span class="hljs-keyword">using</span> JsonString = std::string;<br><span class="hljs-keyword">using</span> JsonNumber = <span class="hljs-type">double</span>;<br><span class="hljs-keyword">using</span> JsonBoolean = <span class="hljs-type">bool</span>;<br></code></pre></td></tr></table></figure></p>
<p>因为一个JSON元素可能为这6个基本数据类型和空值中的任意一个，所以我们需要一个多态类型存储。可以用<code>std::variant</code>来实现这个多态，但我选择虚拟类。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">JsonElementBase</span> {<br>    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">JsonElementBase</span>() = <span class="hljs-keyword">default</span>;<br><br>    [[nodiscard]] <span class="hljs-function"><span class="hljs-keyword">virtual</span> JsonElementBase* <span class="hljs-title">clone</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>= <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// ...</span><br>    <span class="hljs-comment">// 读取和判断值的一些方法</span><br><br>    [[nodiscard]] <span class="hljs-function"><span class="hljs-keyword">virtual</span> std::string <span class="hljs-title">dumps</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>= <span class="hljs-number">0</span>; <span class="hljs-comment">// 将数据转化为JSON文本</span><br>    [[nodiscard]] <span class="hljs-function"><span class="hljs-keyword">virtual</span> JsonType <span class="hljs-title">type</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>= <span class="hljs-number">0</span>; <span class="hljs-comment">// 获取类型</span><br><br>};<br></code></pre></td></tr></table></figure>
<p>为了判断一个JSON元素中到底存储的是什么类型的值，我们需要一个包含6个基本数据类型的枚举。</p>
<p>这里我引入了<em>X-MACRO</em>来简化代码，这个在后面作用比较大。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">define</span> JSON_TYPE_NON_NULL(f) \</span><br><span class="hljs-meta">    f(Object) \</span><br><span class="hljs-meta">    f(Array) \</span><br><span class="hljs-meta">    f(String) \</span><br><span class="hljs-meta">    f(Number) \</span><br><span class="hljs-meta">    f(Boolean)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> JSON_TYPE(f) \</span><br><span class="hljs-meta">    JSON_TYPE_NON_NULL(f) \</span><br><span class="hljs-meta">    f(Null)</span><br><br><span class="hljs-keyword">enum class</span> <span class="hljs-title class_">JsonType</span> {<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> g(x) x,</span><br>    <span class="hljs-built_in">JSON_TYPE</span>(g)<br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> g</span><br>};<br></code></pre></td></tr></table></figure>
<p>接下来可以写完JSON元素的剩余几个接口。<br>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">define</span> g(x) virtual Json##x&amp; as##x() = 0;</span><br>    <span class="hljs-built_in">JSON_TYPE_NON_NULL</span>(g)<br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> g</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> g(x) virtual const Json##x&amp; as##x() const = 0;</span><br>    <span class="hljs-built_in">JSON_TYPE_NON_NULL</span>(g)<br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> g</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> g(x) virtual bool is##x() const = 0;</span><br>    <span class="hljs-built_in">JSON_TYPE</span>(g);<br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> g</span><br></code></pre></td></tr></table></figure><br>
其中包括:<br>
- <code>asXXX()</code>(两个版本): 读取实际存储的值。<br>
- <code>isXXX()</code>: 判断存储的值是否为某类型。</p>
<p>接下来为各各数据类型创建类，以及一种默认情况。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">define</span> ERROR(s) do{throw std::logic_error(s);}while(0)</span><br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">JsonElement</span> : <span class="hljs-keyword">public</span> JsonElementBase {<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> g(x) virtual Json##x&amp; as##x() {ERROR(<span class="hljs-string">"Call 'asXXX()' with wrong type!"</span>);}</span><br>    <span class="hljs-built_in">JSON_TYPE_NON_NULL</span>(g)<br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> g</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> g(x) virtual const Json##x&amp; as##x() const {ERROR(<span class="hljs-string">"Call 'asXXX()' with wrong type!"</span>);}</span><br>    <span class="hljs-built_in">JSON_TYPE_NON_NULL</span>(g)<br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> g</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> g(x) virtual bool is##x() const {return false;}</span><br>    <span class="hljs-built_in">JSON_TYPE</span>(g);<br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> g</span><br>};<br></code></pre></td></tr></table></figure>
<p>默认情况下<code>asXXX()</code>会抛异常，<code>isXXX()</code>返回false。接下来只要覆盖特定功能函数就行了。</p>
<p>后面的代码比较重复，优先写宏。<br>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">define</span> BEGIN_ELEMENT(n) \</span><br><span class="hljs-meta">    struct JsonElement##n : public JsonElement { \</span><br><span class="hljs-meta">        Json##n val; \</span><br><span class="hljs-meta">        JsonElement##n() = default; \</span><br><span class="hljs-meta">        JsonElement##n(const Json##n&amp; val) : val(val) {} \</span><br><span class="hljs-meta">        JsonElement##n(Json##n&amp;&amp; val) : val(std::move(val)) {} \</span><br><span class="hljs-meta">        JsonElementBase* clone() const override {return new JsonElement##n(val);} \</span><br><span class="hljs-meta">        Json##n&amp; as##n() override {return val;} \</span><br><span class="hljs-meta">        const Json##n&amp; as##n() const override {return val;} \</span><br><span class="hljs-meta">        bool is##n() const override {return true;} \</span><br><span class="hljs-meta">        JsonType type() const override {return JsonType:: n;}</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> END_ELEMENT() };</span><br></code></pre></td></tr></table></figure></p>
<p>每个类型实现如下:<br>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-built_in">BEGIN_ELEMENT</span>(Object)<br>    <span class="hljs-function">std::string <span class="hljs-title">dumps</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{<br>        std::stringstream ss;<br>        ss &lt;&lt; val;<br>        <span class="hljs-keyword">return</span> ss.<span class="hljs-built_in">str</span>();<br>    }<br><span class="hljs-built_in">END_ELEMENT</span>() <span class="hljs-comment">// Object</span><br><br><span class="hljs-built_in">BEGIN_ELEMENT</span>(Array)<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> std::string <span class="hljs-title">dumps</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{<br>        std::stringstream ss;<br>        ss &lt;&lt; val;<br>        <span class="hljs-keyword">return</span> ss.<span class="hljs-built_in">str</span>();<br>    }<br><span class="hljs-built_in">END_ELEMENT</span>() <span class="hljs-comment">// Array</span><br><br><span class="hljs-built_in">BEGIN_ELEMENT</span>(String)<br>    <span class="hljs-function">std::string <span class="hljs-title">dumps</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{<br>        std::stringstream ss;<br>        ss &lt;&lt; std::<span class="hljs-built_in">quoted</span>(val);<br>        <span class="hljs-keyword">return</span> ss.<span class="hljs-built_in">str</span>();<br>    }<br><span class="hljs-built_in">END_ELEMENT</span>() <span class="hljs-comment">// String</span><br><br><span class="hljs-built_in">BEGIN_ELEMENT</span>(Number)<br>    <span class="hljs-function">std::string <span class="hljs-title">dumps</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{<br>        <span class="hljs-keyword">auto</span> s = std::<span class="hljs-built_in">to_string</span>(val);<br>        <span class="hljs-keyword">if</span> (s.<span class="hljs-built_in">find</span>(<span class="hljs-string">'.'</span>) &lt; s.<span class="hljs-built_in">size</span>()) {<br>            <span class="hljs-keyword">auto</span> n = s.<span class="hljs-built_in">find_last_not_of</span>(<span class="hljs-string">'0'</span>);<br>            s.<span class="hljs-built_in">erase</span>(s[n<span class="hljs-number">-1</span>] == <span class="hljs-string">'.'</span> ? n<span class="hljs-number">-1</span> : n);<br>        }<br>        <span class="hljs-keyword">return</span> s;<br>    }<br><span class="hljs-built_in">END_ELEMENT</span>() <span class="hljs-comment">// Number</span><br><br><span class="hljs-built_in">BEGIN_ELEMENT</span>(Boolean)<br>    <span class="hljs-function">std::string <span class="hljs-title">dumps</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{<br>        <span class="hljs-keyword">return</span> val ? <span class="hljs-string">"true"</span> : <span class="hljs-string">"false"</span>;<br>    }<br><span class="hljs-built_in">END_ELEMENT</span>() <span class="hljs-comment">// Boolean</span><br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">JsonElementNull</span> : <span class="hljs-keyword">public</span> JsonElement {<br>    <span class="hljs-built_in">JsonElementNull</span>() = <span class="hljs-keyword">default</span>;<br>    <span class="hljs-function">JsonElementBase* <span class="hljs-title">clone</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">JsonElementNull</span>();}<br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">isNull</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;}<br>    <span class="hljs-function">JsonType <span class="hljs-title">type</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{<span class="hljs-keyword">return</span> JsonType::Null;}<br>    <span class="hljs-function">std::string <span class="hljs-title">dumps</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{<span class="hljs-keyword">return</span> <span class="hljs-string">"null"</span>;}<br>}; <span class="hljs-comment">// Null</span><br></code></pre></td></tr></table></figure></p>
<p>除了JSON文本转换没什么特别要写的。不过null比较特殊，因为他没有数据成员。</p>
<h2 id="包装"><a href="#包装" class="headerlink" title="包装"></a>包装</h2>
<p>弄完这些就可以包装为最终的JSON容器了。</p>
<p>看起来像是这样:<br>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Json</span> {<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Json</span>() : <span class="hljs-built_in">element</span>(std::<span class="hljs-built_in">make_unique</span>&lt;JsonElementNull&gt;()) {}<br>    <span class="hljs-built_in">Json</span>(<span class="hljs-type">const</span> Json&amp; o) : <span class="hljs-built_in">element</span>(o.element-&gt;<span class="hljs-built_in">clone</span>());<br>    <span class="hljs-built_in">Json</span>(Json&amp;&amp; o) <span class="hljs-keyword">noexcept</span> : <span class="hljs-built_in">element</span>(std::<span class="hljs-built_in">move</span>(o.element));<br><br>    Json&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> Json&amp; o) {<br>        element.<span class="hljs-built_in">reset</span>(o.element-&gt;<span class="hljs-built_in">clone</span>());<br>    }<br>    Json&amp; <span class="hljs-keyword">operator</span>=(Json&amp;&amp; o) <span class="hljs-keyword">noexcept</span> {<br>        element = std:<span class="hljs-built_in">move</span>(o.element);<br>    }<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> g(x) Json(const Json##x&amp; v);</span><br>    <span class="hljs-built_in">JSON_TYPE_NON_NULL</span>(g)<br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> g</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> g(x) Json(Json##x&amp;&amp; v);</span><br>    <span class="hljs-built_in">JSON_TYPE_NON_NULL</span>(g)<br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> g</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> g(x) Json##x&amp; as##x();</span><br>    <span class="hljs-built_in">JSON_TYPE_NON_NULL</span>(g)<br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> g</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> g(x) const Json##x&amp; as##x() const;</span><br>    <span class="hljs-built_in">JSON_TYPE_NON_NULL</span>(g)<br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> g</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> g(x) bool is##x() const;</span><br>    <span class="hljs-built_in">JSON_TYPE</span>(g);<br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> g</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> g(x) static Json Make##x() {return Json(Json##x{});}</span><br>    <span class="hljs-built_in">JSON_TYPE_NON_NULL</span>(g)<br>    <span class="hljs-function"><span class="hljs-type">static</span> Json <span class="hljs-title">MakeNull</span><span class="hljs-params">()</span> </span>{<span class="hljs-keyword">return</span> Json{};}<br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> g</span><br><br>    <span class="hljs-function">std::string <span class="hljs-title">dumps</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;<br>    <span class="hljs-function">JsonType <span class="hljs-title">type</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;<br><br>    Json&amp; <span class="hljs-keyword">operator</span>[](<span class="hljs-type">const</span> std::string&amp; k) {<br>        <span class="hljs-built_in">assert</span>(<span class="hljs-built_in">isObject</span>() &amp;&amp; <span class="hljs-string">"Element isn't an object!"</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">asObject</span>()[k];<br>    }<br><br>    <span class="hljs-type">const</span> Json&amp; <span class="hljs-keyword">operator</span>[](<span class="hljs-type">const</span> std::string&amp; k) <span class="hljs-type">const</span> {<br>        <span class="hljs-built_in">assert</span>(<span class="hljs-built_in">isObject</span>() &amp;&amp; <span class="hljs-string">"Element isn't an object!"</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">asObject</span>().<span class="hljs-built_in">at</span>(k);<br>    }<br><br>    Json&amp; <span class="hljs-keyword">operator</span>[](<span class="hljs-type">size_t</span> n) {<br>        <span class="hljs-built_in">assert</span>(<span class="hljs-built_in">isArray</span>() &amp;&amp; <span class="hljs-string">"Element isn't an array!"</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">asArray</span>()[n];<br>    }<br><br>    <span class="hljs-type">const</span> Json&amp; <span class="hljs-keyword">operator</span>[](<span class="hljs-type">size_t</span> n) <span class="hljs-type">const</span> {<br>        <span class="hljs-built_in">assert</span>(<span class="hljs-built_in">isArray</span>() &amp;&amp; <span class="hljs-string">"Element isn't an array!"</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">asArray</span>()[n];<br>    }<br><br>    <span class="hljs-keyword">friend</span> std::ostream&amp; <span class="hljs-keyword">operator</span>&lt;&lt;(std::ostream&amp; os, <span class="hljs-type">const</span> Json&amp; json) {<br>        <span class="hljs-keyword">return</span> os &lt;&lt; json-&gt;<span class="hljs-built_in">dumps</span>();<br>    }<br>    <span class="hljs-keyword">friend</span> std::ostream&amp; <span class="hljs-keyword">operator</span>&lt;&lt;(std::ostream&amp; os, <span class="hljs-type">const</span> JsonObject&amp; object) {<br>        os &lt;&lt; <span class="hljs-string">"{"</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> iter = object.<span class="hljs-built_in">begin</span>(); iter != object.<span class="hljs-built_in">end</span>(); iter++) {<br>            os &lt;&lt; <span class="hljs-string">'\"'</span> &lt;&lt; iter-&gt;first &lt;&lt; <span class="hljs-string">'\"'</span> &lt;&lt; <span class="hljs-string">": "</span> &lt;&lt; iter-&gt;second;<br>            <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">next</span>(iter) != object.<span class="hljs-built_in">end</span>()) {<br>                os &lt;&lt; <span class="hljs-string">", "</span>;<br>            }<br>        }<br>        os &lt;&lt; <span class="hljs-string">"}"</span>;<br>        <span class="hljs-keyword">return</span> os;<br>    }<br>    <span class="hljs-keyword">friend</span> std::ostream&amp; <span class="hljs-keyword">operator</span>&lt;&lt;(std::ostream&amp; os, <span class="hljs-type">const</span> JsonArray&amp; array) {<br>        os &lt;&lt; <span class="hljs-string">"["</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; array.<span class="hljs-built_in">size</span>(); i++) {<br>            os &lt;&lt; array[i];<br>            <span class="hljs-keyword">if</span> (i != array.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>) {<br>                os &lt;&lt; <span class="hljs-string">", "</span>;<br>            }<br>        }<br>        os &lt;&lt; <span class="hljs-string">"]"</span>;<br>        <span class="hljs-keyword">return</span> os;<br>    }<br><br><span class="hljs-keyword">private</span>:<br>    std::unique_ptr&lt;JsonElementBase&gt; element;<br><br>};<br></code></pre></td></tr></table></figure><br>
上面的代码省略了部分工具函数的实现。</p>
<h1 id="实现json解析器"><a href="#实现json解析器" class="headerlink" title="实现json解析器"></a>实现JSON解析器</h1>
<p>然后是JSON的解析。</p>
<h2 id="jsonscanner"><a href="#jsonscanner" class="headerlink" title="jsonscanner"></a>JsonScanner</h2>
<p>我们首先需要一个工具类来识别JSON的token。</p>
<p>它应该包含如下功能:<br>
- <code>Scan()</code>: 返回一个token<br>
- <code>Rollback()</code>: 回到上一个token<br>
- <code>GetStringValue()</code>: 返回读到的字符串token的值<br>
- <code>GetNumberValue()</code>: 返回读到的数字token的值</p>
<p>我们需要一个枚举来区分token:<br>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">enum class</span> <span class="hljs-title class_">JsonTokenType</span> {<br>    BEGIN_OBJECT, <span class="hljs-comment">// {</span><br>    END_OBJECT, <span class="hljs-comment">// }</span><br><br>    BEGIN_ARRAY, <span class="hljs-comment">// [</span><br>    END_ARRAY, <span class="hljs-comment">// ]</span><br><br>    VALUE_SEPARATOR, <span class="hljs-comment">// ,</span><br>    NAME_SEPARATOR, <span class="hljs-comment">// :</span><br><br>    VALUE_STRING, <span class="hljs-comment">// "string"</span><br>    VALUE_NUMBER, <span class="hljs-comment">// 1, 2, ...</span><br><br>    LITERAL_TRUE, <span class="hljs-comment">// true</span><br>    LITERAL_FALSE, <span class="hljs-comment">// false</span><br>    LITERAL_NULL, <span class="hljs-comment">// null</span><br><br>    END_OF_SOURCE <span class="hljs-comment">// EOF</span><br>};<br></code></pre></td></tr></table></figure></p>
<p>那么我们就可以开始编写这个类。<br>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">JsonScanner</span> {<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">JsonScanner</span>() = <span class="hljs-keyword">default</span>;<br>    <span class="hljs-built_in">JsonScanner</span>(<span class="hljs-type">const</span> std::string&amp; source) : <span class="hljs-built_in">src</span>(source) {}<br><br>    <span class="hljs-function">JsonTokenType <span class="hljs-title">Scan</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">IsAtEnd</span>()) {<br>            <span class="hljs-keyword">return</span> JsonTokenType::END_OF_SOURCE;<br>        }<br><br>        prev_pos = current;<br><br>        <span class="hljs-type">char</span> c = <span class="hljs-built_in">Advance</span>();<br>        <span class="hljs-keyword">switch</span> (c) {<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">'{'</span>:<br>                <span class="hljs-keyword">return</span> JsonTokenType::BEGIN_OBJECT;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">'}'</span>:<br>                <span class="hljs-keyword">return</span> JsonTokenType::END_OBJECT;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">'['</span>:<br>                <span class="hljs-keyword">return</span> JsonTokenType::BEGIN_ARRAY;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">']'</span>:<br>                <span class="hljs-keyword">return</span> JsonTokenType::END_ARRAY;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">':'</span>:<br>                <span class="hljs-keyword">return</span> JsonTokenType::NAME_SEPARATOR;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">','</span>:<br>                <span class="hljs-keyword">return</span> JsonTokenType::VALUE_SEPARATOR;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">'t'</span>:<br>                <span class="hljs-built_in">ScanTrue</span>();<br>                <span class="hljs-keyword">return</span> JsonTokenType::LITERAL_TRUE;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">'f'</span>:<br>                <span class="hljs-built_in">ScanFlase</span>();<br>                <span class="hljs-keyword">return</span> JsonTokenType::LITERAL_FALSE;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">'n'</span>:<br>                <span class="hljs-built_in">ScanNull</span>();<br>                <span class="hljs-keyword">return</span> JsonTokenType::LITERAL_NULL;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">'"'</span>:<br>                <span class="hljs-built_in">ScanString</span>();<br>                <span class="hljs-keyword">return</span> JsonTokenType::VALUE_STRING;<br><br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">isdigit</span>(c) || c == <span class="hljs-string">'+'</span> || c == <span class="hljs-string">'-'</span>) {<br>                    <span class="hljs-built_in">ScanNumber</span>();<br>                    <span class="hljs-keyword">return</span> JsonTokenType::VALUE_NUMBER;<br>                }<br>                <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">isspace</span>(c)) {<br>                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Scan</span>();<br>                }<br>                <span class="hljs-built_in">ERROR</span>(std::<span class="hljs-built_in">string</span>(<span class="hljs-string">"Unsupported Token: "</span>) + c);<br>                <span class="hljs-keyword">break</span>;<br>        }<br>    }<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Rollback</span><span class="hljs-params">()</span> </span>{<br>        current = prev_pos;<br>    }<br><br>    <span class="hljs-function">JsonString <span class="hljs-title">GetStringValue</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">return</span> value_string;<br>    }<br><br>    <span class="hljs-function">JsonNumber <span class="hljs-title">GetNumberValue</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">return</span> value_number;<br>    }<br><br><span class="hljs-keyword">private</span>:<br>    std::string src; <span class="hljs-comment">// json source</span><br>    <span class="hljs-type">size_t</span> current = <span class="hljs-number">0</span>; <span class="hljs-comment">// current handling pos</span><br>    <span class="hljs-type">size_t</span> prev_pos = <span class="hljs-number">0</span>; <span class="hljs-comment">// previous handling pos</span><br>    JsonString value_string;<br>    JsonNumber value_number;<br><br>    <span class="hljs-comment">// ...</span><br>    <span class="hljs-comment">// 其他成员函数</span><br>};<br></code></pre></td></tr></table></figure><br>
基本逻辑就是看到什么就读什么，我们只需要识别和跳过字符。</p>
<p>成员函数:<br>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">IsAtEnd</span><span class="hljs-params">()</span> </span>{<br>    <span class="hljs-keyword">return</span> current &gt;= src.<span class="hljs-built_in">size</span>();<br>}<br><br><span class="hljs-function"><span class="hljs-type">char</span> <span class="hljs-title">Advance</span><span class="hljs-params">()</span> </span>{<br>    <span class="hljs-keyword">if</span> (current &lt; src.<span class="hljs-built_in">size</span>()) <span class="hljs-keyword">return</span> src[current++];<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br><br><span class="hljs-function"><span class="hljs-type">char</span> <span class="hljs-title">Peek</span><span class="hljs-params">()</span> </span>{<br>    <span class="hljs-keyword">if</span> (current &lt; src.<span class="hljs-built_in">size</span>()) <span class="hljs-keyword">return</span> src[current];<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br><br><span class="hljs-function"><span class="hljs-type">char</span> <span class="hljs-title">PeekNext</span><span class="hljs-params">()</span> </span>{<br>    <span class="hljs-keyword">if</span> (current &lt; src.<span class="hljs-built_in">size</span>()) <span class="hljs-keyword">return</span> src[current + <span class="hljs-number">1</span>];<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ScanTrue</span><span class="hljs-params">()</span> </span>{<br>    <span class="hljs-keyword">if</span> (src.<span class="hljs-built_in">compare</span>(current, <span class="hljs-number">3</span>, <span class="hljs-string">"rue"</span>) == <span class="hljs-number">0</span>) {<br>        current += <span class="hljs-number">3</span>;<br>    } <span class="hljs-keyword">else</span> {<br>        <span class="hljs-built_in">ERROR</span>(<span class="hljs-string">"Scan 'true' error"</span>);<br>    }<br>}<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ScanFlase</span><span class="hljs-params">()</span> </span>{<br>    <span class="hljs-keyword">if</span> (src.<span class="hljs-built_in">compare</span>(current, <span class="hljs-number">4</span>, <span class="hljs-string">"alse"</span>) == <span class="hljs-number">0</span>) {<br>        current += <span class="hljs-number">4</span>;<br>    } <span class="hljs-keyword">else</span> {<br>        <span class="hljs-built_in">ERROR</span>(<span class="hljs-string">"Scan 'false' error"</span>);<br>    }<br>}<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ScanNull</span><span class="hljs-params">()</span> </span>{<br>    <span class="hljs-keyword">if</span> (src.<span class="hljs-built_in">compare</span>(current, <span class="hljs-number">3</span>, <span class="hljs-string">"ull"</span>) == <span class="hljs-number">0</span>) {<br>        current += <span class="hljs-number">3</span>;<br>    } <span class="hljs-keyword">else</span> {<br>        <span class="hljs-built_in">ERROR</span>(<span class="hljs-string">"Scan 'null' error"</span>);<br>    }<br>}<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ScanNumber</span><span class="hljs-params">()</span> </span>{<br>    <span class="hljs-keyword">auto</span> pos = current - <span class="hljs-number">1</span>;<br><br>    <span class="hljs-type">bool</span> dotflag = <span class="hljs-literal">true</span>, eflag = <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-keyword">while</span> (std::<span class="hljs-built_in">isdigit</span>(<span class="hljs-built_in">Peek</span>()) ||<br>            (<span class="hljs-built_in">Peek</span>() == <span class="hljs-string">'.'</span> &amp;&amp; dotflag) ||<br>            ((<span class="hljs-built_in">Peek</span>() == <span class="hljs-string">'e'</span> || <span class="hljs-built_in">Peek</span>() == <span class="hljs-string">'E'</span>) &amp;&amp; eflag)) {<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Peek</span>() == <span class="hljs-string">'.'</span>) {<br>            dotflag = <span class="hljs-literal">false</span>;<br>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Peek</span>() == <span class="hljs-string">'e'</span> || <span class="hljs-built_in">Peek</span>() == <span class="hljs-string">'E'</span>) {<br>            eflag = <span class="hljs-literal">false</span>;<br>            <span class="hljs-built_in">Advance</span>(); <span class="hljs-comment">// '+' and '-' may follow 'e'</span><br>        }<br>        <span class="hljs-built_in">Advance</span>();<br>    }<br><br>    value_number = std::<span class="hljs-built_in">stof</span>(src.<span class="hljs-built_in">substr</span>(pos, current - pos));<br>}<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ScanString</span><span class="hljs-params">()</span> </span>{<br>    std::string r;<br>    <span class="hljs-type">char</span> c;<br>    <span class="hljs-keyword">while</span>((c = <span class="hljs-built_in">Advance</span>()) != <span class="hljs-string">'"'</span> &amp;&amp; !<span class="hljs-built_in">IsAtEnd</span>()) {<br>        <span class="hljs-keyword">if</span> (c == <span class="hljs-string">'\\'</span>) {<br>            <span class="hljs-keyword">switch</span> (c = <span class="hljs-built_in">Advance</span>()) {<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">'\\'</span>: r += <span class="hljs-string">'\\'</span>; <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">'n'</span>: r += <span class="hljs-string">'\n'</span>; <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">'t'</span>: r += <span class="hljs-string">'\t'</span>; <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">'r'</span>: r += <span class="hljs-string">'\r'</span>; <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">'b'</span>: r += <span class="hljs-string">'\b'</span>;  <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">'f'</span>: r += <span class="hljs-string">'\f'</span>; <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">'a'</span>: r += <span class="hljs-string">'\a'</span>; <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">'v'</span>: r += <span class="hljs-string">'\v'</span>; <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">default</span>: r += c; <span class="hljs-keyword">break</span>;<br>            }<br>        } <span class="hljs-keyword">else</span> {<br>            r += c;<br>        }<br>    }<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">IsAtEnd</span>()) {<br>        <span class="hljs-built_in">ERROR</span>(<span class="hljs-string">"Invalid string: missing closing quote!"</span>);<br>    }<br>    value_string = r;<br>}<br></code></pre></td></tr></table></figure><br>
字符串会麻烦一点，因为要处理转意符。</p>
<h2 id="jsonparser"><a href="#jsonparser" class="headerlink" title="jsonparser"></a>JsonParser</h2>
<p>最后是这个用于解析的类。通过一个<code>Parse()</code>函数返回解析的Json实例。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">JsonParser</span> {<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">JsonParser</span>() = <span class="hljs-keyword">default</span>;<br>    <span class="hljs-built_in">JsonParser</span>(<span class="hljs-type">const</span> std::string&amp; str) : <span class="hljs-built_in">scanner</span>(str) {}<br>    <span class="hljs-built_in">JsonParser</span>(<span class="hljs-type">const</span> JsonScanner&amp; scanner) : <span class="hljs-built_in">scanner</span>(scanner) {}<br><br>    <span class="hljs-function">Json <span class="hljs-title">Parse</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">auto</span> token_type = scanner.<span class="hljs-built_in">Scan</span>();<br><br>        <span class="hljs-keyword">switch</span> (token_type) {<br>            <span class="hljs-keyword">case</span> JsonTokenType::BEGIN_OBJECT:<br>                <span class="hljs-keyword">return</span> {<span class="hljs-built_in">ParseObject</span>()};<br><br>            <span class="hljs-keyword">case</span> JsonTokenType::BEGIN_ARRAY:<br>                <span class="hljs-keyword">return</span> {<span class="hljs-built_in">ParseArray</span>()};<br><br>            <span class="hljs-keyword">case</span> JsonTokenType::VALUE_STRING: {<br>                <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; str = scanner.<span class="hljs-built_in">GetStringValue</span>();<br>                <span class="hljs-keyword">return</span> {str};<br>            }<br><br>            <span class="hljs-keyword">case</span> JsonTokenType::VALUE_NUMBER: {<br>                <span class="hljs-keyword">auto</span> num = scanner.<span class="hljs-built_in">GetNumberValue</span>();<br>                <span class="hljs-keyword">return</span> {num};<br>            }<br><br>            <span class="hljs-keyword">case</span> JsonTokenType::LITERAL_TRUE:<br>                <span class="hljs-keyword">return</span> {<span class="hljs-literal">true</span>};<br><br>            <span class="hljs-keyword">case</span> JsonTokenType::LITERAL_FALSE:<br>                <span class="hljs-keyword">return</span> {<span class="hljs-literal">false</span>};<br><br>            <span class="hljs-keyword">case</span> JsonTokenType::LITERAL_NULL:<br>            <span class="hljs-keyword">case</span> JsonTokenType::END_OF_SOURCE:<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">return</span> {};<br>        }<br>    }<br><br><span class="hljs-keyword">private</span>:<br>    JsonScanner scanner;<br><br>    <span class="hljs-function">JsonObject <span class="hljs-title">ParseObject</span><span class="hljs-params">()</span></span>;<br><br>    <span class="hljs-function">JsonArray <span class="hljs-title">ParseArray</span><span class="hljs-params">()</span></span>;<br>};<br></code></pre></td></tr></table></figure>
<p>同样的逻辑，根据token判断值，只是如果是JSON对象和数组的话就需要递归读取。</p>
<p>对象需要分别读键和值。<br>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">JsonObject <span class="hljs-title">ParseObject</span><span class="hljs-params">()</span> </span>{<br>    JsonObject rst{};<br><br>    <span class="hljs-keyword">auto</span> next = scanner.<span class="hljs-built_in">Scan</span>();<br>    <span class="hljs-keyword">if</span> (next == JsonScanner::JsonTokenType::END_OBJECT) {<br>        <span class="hljs-keyword">return</span> rst;<br>    }<br>    scanner.<span class="hljs-built_in">Rollback</span>();<br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {<br>        next = scanner.<span class="hljs-built_in">Scan</span>();<br>        <span class="hljs-keyword">if</span> (next != JsonScanner::JsonTokenType::VALUE_STRING) {<br>            <span class="hljs-built_in">ERROR</span>(<span class="hljs-string">"Key must be string!"</span>);<br>        }<br>        std::string key = scanner.<span class="hljs-built_in">GetStringValue</span>();<br>        next = scanner.<span class="hljs-built_in">Scan</span>();<br>        <span class="hljs-keyword">if</span> (next != JsonScanner::JsonTokenType::NAME_SEPARATOR) {<br>            <span class="hljs-built_in">ERROR</span>(<span class="hljs-string">"Expected ':'!"</span>);<br>        }<br>        rst.<span class="hljs-built_in">insert</span>({key, <span class="hljs-built_in">Parse</span>()});<br>        next = scanner.<span class="hljs-built_in">Scan</span>();<br>        <span class="hljs-keyword">if</span> (next == JsonScanner::JsonTokenType::END_OBJECT) {<br>            <span class="hljs-keyword">break</span>;<br>        }<br>        <span class="hljs-keyword">if</span> (next != JsonScanner::JsonTokenType::VALUE_SEPARATOR) {<br>            <span class="hljs-built_in">ERROR</span>(<span class="hljs-string">"Expected ','!"</span>);<br>        }<br>    }<br><br>    <span class="hljs-keyword">return</span> rst;<br>}<br></code></pre></td></tr></table></figure></p>
<p>数组一个一个读取就行。<br>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">JsonArray <span class="hljs-title">ParseArray</span><span class="hljs-params">()</span> </span>{<br>    JsonArray rst;<br><br>    <span class="hljs-keyword">auto</span> next = scanner.<span class="hljs-built_in">Scan</span>();<br>    <span class="hljs-keyword">if</span> (next == JsonScanner::JsonTokenType::END_ARRAY) {<br>        <span class="hljs-keyword">return</span> rst;<br>    }<br>    scanner.<span class="hljs-built_in">Rollback</span>();<br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {<br>        rst.<span class="hljs-built_in">push_back</span>(<span class="hljs-built_in">Parse</span>());<br>        next = scanner.<span class="hljs-built_in">Scan</span>();<br><br>        <span class="hljs-keyword">if</span> (next == JsonScanner::JsonTokenType::END_ARRAY) {<br>            <span class="hljs-keyword">break</span>;<br>        }<br><br>        <span class="hljs-keyword">if</span> (next != JsonScanner::JsonTokenType::VALUE_SEPARATOR) {<br>            <span class="hljs-built_in">ERROR</span>(<span class="hljs-string">"Expected ','!"</span>);<br>        }<br>    }<br><br>    <span class="hljs-keyword">return</span> rst;<br>}<br></code></pre></td></tr></table></figure></p>
<p>别让别人吃你拉的屎。<br>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">undef</span> BEGIN_ELEMENT</span><br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> END_ELEMENT</span><br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> ERROR</span><br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> JSON_TYPE</span><br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> JSON_TYPE_NON_NULL</span><br></code></pre></td></tr></table></figure></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2024/08/11/weighted-blended/">← Next weighted blended</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2024/03/10/%E4%BA%8C%E5%8F%89%E6%A0%91%E6%B5%85%E8%B0%88/">二叉树浅谈 Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">Dr. Ninter6</a></h1><div id="description"><p></p></div><div id="social-links"><a class="social" target="_blank" rel="noopener" href="https://github.com/Ninter6"><i class="fab fa-github" alt="GitHub"></i></a></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95"><span class="toc-number">1.</span> <span class="toc-text">目录</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">2.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFjson"><span class="toc-number">3.</span> <span class="toc-text">什么是JSON</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#json%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.1.</span> <span class="toc-text">JSON的基本数据类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#json%E4%B8%AD%E7%9A%84token"><span class="toc-number">3.2.</span> <span class="toc-text">JSON中的token</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B0%81%E8%A3%85%E4%B8%80%E4%B8%AAjson%E5%AE%B9%E5%99%A8"><span class="toc-number">4.</span> <span class="toc-text">封装一个JSON容器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8"><span class="toc-number">4.1.</span> <span class="toc-text">数据存储</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8C%85%E8%A3%85"><span class="toc-number">4.2.</span> <span class="toc-text">包装</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0json%E8%A7%A3%E6%9E%90%E5%99%A8"><span class="toc-number">5.</span> <span class="toc-text">实现JSON解析器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#jsonscanner"><span class="toc-number">5.1.</span> <span class="toc-text">JsonScanner</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jsonparser"><span class="toc-number">5.2.</span> <span class="toc-text">JsonParser</span></a></li></ol></li></ol></div></div><footer><nobr><span class="icp-title">©️</span><span class="icp-content">Ninter Z</span></nobr><br><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas></body></html>