<!DOCTYPE html><html lang="zh-CN" theme-mode="auto"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>weighted blended | 60Hz Viewing</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="preload" as="font" crossorigin="anonymous" href="/font/Bender.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/BenderLight.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/JetBrainsMono-Regular.woff2"><link rel="stylesheet" href="/css/arknights.css"><style>@font-face {
  font-family: Bender;
  src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
  font-family: BenderLight;
  src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
  font-family: 'JetBrains Mono';
  src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}
</style><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 - $1 行","copy":"复制"}}</script><link type="text/css" rel="stylesheet" href="/lib/encrypt/hbe.style.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><script>if (window.localStorage.getItem('theme-mode') === 'light' || window.matchMedia('(prefers-color-scheme:light)').matches)
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark' || window.matchMedia('(prefers-color-scheme:dark)').matches)
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>:root {
 --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
 --light-background: url('/img/bk.jpg');
 --theme-encrypt-confirm: '确认'
}</style><script defer src="/js/arknights.js"></script><script defer src="/js/search.js"></script><script defer type="module">import mermaid from '//unpkg.com/mermaid@10.5.0/dist/mermaid.esm.mjs';
window.mermaid = mermaid;
code.paintMermaid();
</script><script async src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script async src="/lib/encrypt/hbe.js"></script><script async src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js','data-pjax','.busuanzi'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><meta name="generator" content="Hexo 7.1.1"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup" tabindex="0"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>weighted blended</h1><div id="post-info"><span>文章发布时间: <div class="control"><time datetime="2024-08-11T10:01:11.000Z" id="date"> 2024-08-11</time></div></span><br><span>最后更新时间: <div class="control"><time datetime="2024-08-11T16:14:12.066Z" id="updated"> 2024-08-12</time></div></span></div></div><hr><div id="post-content"><details>
<summary>
前言(废话)
</summary>
赶快水一篇，不然暑假就结束了
</details>
<h1 id="weighted-blended"><a href="#weighted-blended" class="headerlink" title="weighted-blended"></a>Weighted Blended</h1>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2>
<p><strong>Weighted
Blended</strong>是一种较为简单的，快速高效的顺序无关混合算法，它大多数情况下比排序图元或者片元快得多，<br>
相对空间的占用也较小。</p>
<p><strong>Weighted
Blended</strong>通过计算一个权重，其只与颜色的alpha和片元的深度有关，以此做到与混合的顺序无关。</p>
<p>使用这种技术需要对渲染管线的修改是非常小的。非透明部分的渲染会原封不动地保留，只需要对透明物体渲染做特殊处理，最后叠加到非透明部分上。这对旧代码非常友善。</p>
<blockquote>
<p>更多介绍请看Learn OpenGL：<a target="_blank" rel="noopener" href="https://learnopengl.com/Guest-Articles/2020/OIT/Weighted-Blended">Weighted
Blended</a></p>
</blockquote>
<p>本文将探讨其的实现，无关内容不作过多赘述</p>
<h2 id="预览"><a href="#预览" class="headerlink" title="预览"></a>预览</h2>
<p>实现此算法的步骤如下:</p>
<ol type="1">
<li>创建帧缓冲，以及至少两个颜色附件(revealage, accumulation)</li>
<li>渲染不透明物体</li>
<li>配置透明pass</li>
<li>渲染透明物体</li>
<li>叠加帧缓冲内容到不透明帧缓冲上</li>
</ol>
<blockquote>
<p>如果要使用深度测试，将深度附件也绑定到帧缓冲上，这样的话你可能需要为不透明物体也创建一个帧缓冲(或着一个帧缓冲带有两个pass)</p>
</blockquote>
<p>因为要透明pass要输出到两个附件上，所以需要OpenGL4.0以上的版本。在不支持此版本的设备上，渲染两次可能是最简单的方法。</p>
<p>先让我们编写一个简单的程序，没有实现OIT:<br>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cassert&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"glad/glad.h"</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"GLFW/glfw3.h"</span></span><br><br><span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> W = <span class="hljs-number">800</span>, H = <span class="hljs-number">500</span>;<br><span class="hljs-keyword">constexpr</span> <span class="hljs-type">float</span> vert[] = { <span class="hljs-number">-.5</span>,<span class="hljs-number">-.5</span>, <span class="hljs-number">.5</span>,<span class="hljs-number">.5</span>, <span class="hljs-number">.5</span>,<span class="hljs-number">-.5</span>, <span class="hljs-number">-.5</span>,<span class="hljs-number">.5</span>, <span class="hljs-number">.5</span>,<span class="hljs-number">.5</span>, <span class="hljs-number">-.5</span>,<span class="hljs-number">-.5</span> };<br><br><span class="hljs-type">float</span> proj[<span class="hljs-number">4</span>*<span class="hljs-number">4</span>]{}, _init_matrix = ([]{ <span class="hljs-comment">// NOLINT(*-reserved-identifier)</span><br>    <span class="hljs-type">float</span> aspect = (<span class="hljs-type">float</span>)W / (<span class="hljs-type">float</span>)H;<br>    <span class="hljs-type">float</span> tanHalfFov = std::<span class="hljs-built_in">tan</span>(<span class="hljs-number">.5</span>f); <span class="hljs-comment">// tan(pi/3/2)</span><br>    <span class="hljs-type">float</span> near = <span class="hljs-number">0.1f</span>, far = <span class="hljs-number">100.0f</span>;<br>    proj[<span class="hljs-number">0</span>] = <span class="hljs-number">1.0f</span> / (aspect * tanHalfFov);<br>    proj[<span class="hljs-number">5</span>] = <span class="hljs-number">1.0f</span> / tanHalfFov;<br>    proj[<span class="hljs-number">10</span>] = (far + near) / (near - far);<br>    proj[<span class="hljs-number">11</span>] =<span class="hljs-number">-1.0f</span>;<br>    proj[<span class="hljs-number">14</span>] = (<span class="hljs-number">2.0f</span> * far * near) / (near - far);<br>}(), <span class="hljs-number">0.f</span>);<br><br><span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">auto</span> circle_vsh = <span class="hljs-string">R"(</span><br><span class="hljs-string">#version 410 core</span><br><span class="hljs-string">layout (location = 0) in vec2 pos;</span><br><span class="hljs-string">out vec2 fragUV;</span><br><span class="hljs-string">out vec4 fragCol;</span><br><span class="hljs-string">uniform float t;</span><br><span class="hljs-string">uniform mat4 proj;</span><br><span class="hljs-string">const vec4 colors[] = vec4[](</span><br><span class="hljs-string">    vec4(.06f, .93f, .8f, .5f),</span><br><span class="hljs-string">    vec4(1.f, .68f, .2f, .5f),</span><br><span class="hljs-string">    vec4(.37f, .83f, .09f, .5f),</span><br><span class="hljs-string">    vec4(.87f, .93f, .2f, .5f),</span><br><span class="hljs-string">    vec4(1.f, .67, .47f, .5f),</span><br><span class="hljs-string">    vec4(1.f, .37f, .4f, .5f)</span><br><span class="hljs-string">);</span><br><span class="hljs-string">void main() {</span><br><span class="hljs-string">    fragUV = pos * 2;</span><br><span class="hljs-string">    fragCol = colors[gl_InstanceID];</span><br><span class="hljs-string">    vec4 p = vec4(pos.x - sin(t + gl_InstanceID), pos.y, -3 - cos(t + gl_InstanceID), 1);</span><br><span class="hljs-string">    gl_Position = proj * p;</span><br><span class="hljs-string">})"</span>, circle_fsh = <span class="hljs-string">R"(</span><br><span class="hljs-string">#version 410 core</span><br><span class="hljs-string">in vec2 fragUV;</span><br><span class="hljs-string">in vec4 fragCol;</span><br><span class="hljs-string">out vec4 color;</span><br><span class="hljs-string">void main() {</span><br><span class="hljs-string">    if (length(fragUV) &gt; 0.8) discard;</span><br><span class="hljs-string">    color = fragCol;</span><br><span class="hljs-string">})"</span>;<br><br><span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">auto</span> homo_vsh = <span class="hljs-string">R"(</span><br><span class="hljs-string">#version 410 core</span><br><span class="hljs-string">layout (location = 0) in vec2 pos;</span><br><span class="hljs-string">vec2 scale[] = vec2[](</span><br><span class="hljs-string">    vec2(2./25., 1),</span><br><span class="hljs-string">    vec2(2./25., 1),</span><br><span class="hljs-string">    vec2(2./25., 3./5.), vec2(2./25., 1./5.), vec2(2./25., 1),</span><br><span class="hljs-string">    vec2(6./25., 1./5.), vec2(2./25., 1./5.), vec2(6./25., 1./5.), vec2(2./25., 1./5.), vec2(6./25., 1./5.),</span><br><span class="hljs-string">    vec2(2./25., 1),</span><br><span class="hljs-string">    vec2(2./25., 3./5.), vec2(2./25., 1./5.), vec2(2./25., 1)</span><br><span class="hljs-string">);</span><br><span class="hljs-string">vec2 offset[] = vec2[](</span><br><span class="hljs-string">    vec2(-16./25., 0),</span><br><span class="hljs-string">    vec2(-12./25., 0),</span><br><span class="hljs-string">    vec2(-8./25., 1./5.), vec2(-6./25., 0), vec2(-4./25., 0),</span><br><span class="hljs-string">    vec2(2./25., 2./5.), vec2(0, 1./5.), vec2(2./25., 0), vec2(4./25., -1./5.), vec2(2./25., -2./5.),</span><br><span class="hljs-string">    vec2(8./25., 0),</span><br><span class="hljs-string">    vec2(12./25., 1./5.), vec2(14./25., 0), vec2(16./25., 0)</span><br><span class="hljs-string">);</span><br><span class="hljs-string">void main() {</span><br><span class="hljs-string">    gl_Position = vec4(pos * scale[gl_InstanceID] + offset[gl_InstanceID], 0, 1);</span><br><span class="hljs-string">})"</span>, homo_fsh = <span class="hljs-string">R"(</span><br><span class="hljs-string">#version 410 core</span><br><span class="hljs-string">out vec4 color;</span><br><span class="hljs-string">void main() { color = vec4(1, 0.333, 0, 1); }</span><br><span class="hljs-string">)"</span>;<br><br>GLFWwindow* window;<br><br><span class="hljs-function">GLuint <span class="hljs-title">createShader</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* vsh, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* fsh)</span></span>;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">glfwInit</span>() == GLFW_FALSE)<br>        <span class="hljs-built_in">assert</span>(<span class="hljs-literal">false</span> &amp;&amp; <span class="hljs-string">"failed to initialize GLFW"</span>);<br>    <span class="hljs-built_in">glfwWindowHint</span>(GLFW_CONTEXT_VERSION_MAJOR, <span class="hljs-number">4</span>);<br>    <span class="hljs-built_in">glfwWindowHint</span>(GLFW_CONTEXT_VERSION_MINOR, <span class="hljs-number">1</span>);<br>    <span class="hljs-built_in">glfwWindowHint</span>(GLFW_OPENGL_PROFILE, GLFW_OPENGL_CORE_PROFILE);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> __APPLE__</span><br>    <span class="hljs-built_in">glfwWindowHint</span>(GLFW_OPENGL_FORWARD_COMPAT, GL_TRUE);<br>    window = <span class="hljs-built_in">glfwCreateWindow</span>(W/<span class="hljs-number">2</span>, H/<span class="hljs-number">2</span>, <span class="hljs-string">"weighted blended"</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    window = <span class="hljs-built_in">glfwCreateWindow</span>(W, H, <span class="hljs-string">"weighted blended"</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-built_in">assert</span>(window &amp;&amp; <span class="hljs-string">"failed to create window"</span>);<br><br>    <span class="hljs-built_in">glfwMakeContextCurrent</span>(window);<br><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">gladLoadGLLoader</span>((GLADloadproc)glfwGetProcAddress))<br>        <span class="hljs-built_in">assert</span>(<span class="hljs-literal">false</span> &amp;&amp; <span class="hljs-string">"failed to initialize GLAD"</span>);<br><br>    <span class="hljs-built_in">glEnable</span>(GL_BLEND);<br>    <span class="hljs-built_in">glBlendFunc</span>(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);<br><br>    <span class="hljs-built_in">glViewport</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, W, H);<br><br>    GLuint circle = <span class="hljs-built_in">createShader</span>(circle_vsh, circle_fsh), homo = <span class="hljs-built_in">createShader</span>(homo_vsh, homo_fsh);<br>    <span class="hljs-built_in">glUseProgram</span>(circle);<br>    <span class="hljs-built_in">glUniformMatrix4fv</span>(<span class="hljs-built_in">glGetUniformLocation</span>(circle, <span class="hljs-string">"proj"</span>), <span class="hljs-number">1</span>, GL_FALSE, proj);<br><br>    GLuint vao, vbo;<br>    <span class="hljs-built_in">glGenVertexArrays</span>(<span class="hljs-number">1</span>, &amp;vao);<br>    <span class="hljs-built_in">glBindVertexArray</span>(vao);<br>    <span class="hljs-built_in">glGenBuffers</span>(<span class="hljs-number">1</span>, &amp;vbo);<br>    <span class="hljs-built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, vbo);<br>    <span class="hljs-built_in">glBufferData</span>(GL_ARRAY_BUFFER, <span class="hljs-built_in">sizeof</span>(vert), vert, GL_STATIC_DRAW);<br>    <span class="hljs-built_in">glVertexAttribPointer</span>(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, GL_FLOAT, GL_FALSE, <span class="hljs-number">2</span> * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>), <span class="hljs-literal">nullptr</span>);<br>    <span class="hljs-built_in">glEnableVertexAttribArray</span>(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">while</span> (!<span class="hljs-built_in">glfwWindowShouldClose</span>(window)) {<br>        <span class="hljs-built_in">glClearColor</span>(<span class="hljs-number">0.2f</span>, <span class="hljs-number">0.3f</span>, <span class="hljs-number">0.3f</span>, <span class="hljs-number">1.0f</span>);<br>        <span class="hljs-built_in">glClear</span>(GL_COLOR_BUFFER_BIT);<br><br>        <span class="hljs-built_in">glUseProgram</span>(homo);<br>        <span class="hljs-built_in">glDrawArraysInstanced</span>(GL_TRIANGLES, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">14</span>);<br><br>        <span class="hljs-built_in">glUseProgram</span>(circle);<br>        <span class="hljs-built_in">glUniform1f</span>(<span class="hljs-built_in">glGetUniformLocation</span>(circle, <span class="hljs-string">"t"</span>), (<span class="hljs-type">float</span>)<span class="hljs-built_in">glfwGetTime</span>() * <span class="hljs-number">.5</span>f);<br>        <span class="hljs-built_in">glDrawArraysInstanced</span>(GL_TRIANGLES, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">6</span>);<br><br>        <span class="hljs-built_in">glfwSwapBuffers</span>(window);<br>        <span class="hljs-built_in">glfwPollEvents</span>();<br>    }<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br><br><span class="hljs-function">GLuint <span class="hljs-title">createShader</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* vsh, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* fsh)</span> </span>{<br>    GLuint vertexShader = <span class="hljs-built_in">glCreateShader</span>(GL_VERTEX_SHADER);<br>    <span class="hljs-built_in">glShaderSource</span>(vertexShader, <span class="hljs-number">1</span>, &amp;vsh, <span class="hljs-literal">nullptr</span>);<br>    <span class="hljs-built_in">glCompileShader</span>(vertexShader);<br><br>    GLuint fragmentShader = <span class="hljs-built_in">glCreateShader</span>(GL_FRAGMENT_SHADER);<br>    <span class="hljs-built_in">glShaderSource</span>(fragmentShader, <span class="hljs-number">1</span>, &amp;fsh, <span class="hljs-literal">nullptr</span>);<br>    <span class="hljs-built_in">glCompileShader</span>(fragmentShader);<br><br>    GLuint program = <span class="hljs-built_in">glCreateProgram</span>();<br>    <span class="hljs-built_in">glAttachShader</span>(program, vertexShader);<br>    <span class="hljs-built_in">glAttachShader</span>(program, fragmentShader);<br>    <span class="hljs-built_in">glLinkProgram</span>(program);<br><br>    GLint success;<br>    <span class="hljs-built_in">glGetProgramiv</span>(program, GL_LINK_STATUS, &amp;success);<br>    <span class="hljs-keyword">if</span>(!success) {<br>        GLint length;<br>        <span class="hljs-built_in">glGetProgramiv</span>(program, GL_INFO_LOG_LENGTH, &amp;length);<br>        <span class="hljs-function">std::string <span class="hljs-title">infoLog</span><span class="hljs-params">(<span class="hljs-string">"\0"</span>, length)</span></span>;<br>        <span class="hljs-built_in">glGetProgramInfoLog</span>(program, <span class="hljs-number">512</span>, <span class="hljs-literal">nullptr</span>, infoLog.<span class="hljs-built_in">data</span>());<br>        <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"Failed to link shader:\n"</span> + infoLog);<br>    }<br><br>    <span class="hljs-built_in">glDeleteShader</span>(vertexShader);<br>    <span class="hljs-built_in">glDeleteShader</span>(fragmentShader);<br><br>    <span class="hljs-keyword">return</span> program;<br>}<br></code></pre></td></tr></table></figure></p>
<p>如果正常编译你将看到以下图像，当然效果不尽人意。<br class='item-img' data-src='https://pic.imge.cc/2024/08/11/66b8b92cf2382.gif'><img src="https://pic.imge.cc/2024/08/11/66b8b92cf2382.gif"></p>
<h2 id="创建帧缓冲"><a href="#创建帧缓冲" class="headerlink" title="创建帧缓冲"></a>创建帧缓冲</h2>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c++">GLuint fbo;<br><span class="hljs-built_in">glGenFramebuffers</span>(<span class="hljs-number">1</span>, &amp;fbo);<br><span class="hljs-built_in">glBindFramebuffer</span>(GL_FRAMEBUFFER, fbo);<br></code></pre></td></tr></table></figure>
<p>然后是必要的accum和reveal附件。下面这个表格清晰明了地展示了两份附件和其内容的关系:</p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">附件</th>
<th style="text-align: center;">格式</th>
<th style="text-align: center;">clear</th>
<th style="text-align: center;">blend func</th>
<th style="text-align: center;">内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">accum</td>
<td style="text-align: center;">RGBA16F</td>
<td style="text-align: center;">(0,0,0,0)</td>
<td style="text-align: center;">ONE, ONE</td>
<td style="text-align: center;">(rgb * a, a) * w</td>
</tr>
<tr class="even">
<td style="text-align: left;">reveal</td>
<td style="text-align: center;">R8</td>
<td style="text-align: center;">(1,0,0,0)</td>
<td style="text-align: center;">ZERO, ONE_MINUS_SRC_COLOR</td>
<td style="text-align: center;">a</td>
</tr>
</tbody>
</table>
<p>这两个附件的精度都不需要太高。<br>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">GLuint accum, reveal;<br>GLuint accum, reveal;<br>glGenTextures(1, &amp;accum);<br>glBindTexture(GL_TEXTURE_2D, accum);<br>glTexImage2D(GL_TEXTURE_2D, 0, GL_RGBA16F, W, H, 0, GL_RGBA, GL_HALF_FLOAT, nullptr);<br>glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);<br>glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);<br>glGenTextures(1, &amp;reveal);<br>glBindTexture(GL_TEXTURE_2D, reveal);<br>glTexImage2D(GL_TEXTURE_2D, 0, GL_R8, W, H, 0, GL_RED, GL_FLOAT, nullptr);<br>glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);<br>glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);<br></code></pre></td></tr></table></figure></p>
<p>将附件绑定到帧缓冲:<br>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-built_in">glBindFramebuffer</span>(GL_FRAMEBUFFER, fbo);<br><span class="hljs-built_in">glFramebufferTexture2D</span>(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D, accum, <span class="hljs-number">0</span>);<br><span class="hljs-built_in">glFramebufferTexture2D</span>(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENT1, GL_TEXTURE_2D, reveal, <span class="hljs-number">0</span>);<br><br><span class="hljs-type">const</span> GLenum attachments[] = { GL_COLOR_ATTACHMENT0, GL_COLOR_ATTACHMENT1 };<br><span class="hljs-built_in">glDrawBuffers</span>(<span class="hljs-number">2</span>, attachments);<br></code></pre></td></tr></table></figure></p>
<h2 id="渲染不透明物体"><a href="#渲染不透明物体" class="headerlink" title="渲染不透明物体"></a>渲染不透明物体</h2>
<p>在这个例子中，直接绑定默认帧缓冲渲染就可以了。<br>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">while</span> (!<span class="hljs-built_in">glfwWindowShouldClose</span>(window)) {<br>    <span class="hljs-built_in">glBindFramebuffer</span>(GL_FRAMEBUFFER, <span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">glClearColor</span>(<span class="hljs-number">0.2f</span>, <span class="hljs-number">0.3f</span>, <span class="hljs-number">0.3f</span>, <span class="hljs-number">1.0f</span>);<br>    <span class="hljs-built_in">glClear</span>(GL_COLOR_BUFFER_BIT);<br><br>    <span class="hljs-built_in">glDisable</span>(GL_BLEND);<br>    <span class="hljs-built_in">glUseProgram</span>(homo);<br>    <span class="hljs-built_in">glDrawArraysInstanced</span>(GL_TRIANGLES, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">14</span>);<br><br>    ...<br>}<br></code></pre></td></tr></table></figure></p>
<h2 id="渲染透明物体"><a href="#渲染透明物体" class="headerlink" title="渲染透明物体"></a>渲染透明物体</h2>
<p>两个附件的混合函数不同，需要用<code>glBlendFunci</code>为它们分别配置。<br>
注意，清除附件的颜色不一样。<br>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">while</span> (!<span class="hljs-built_in">glfwWindowShouldClose</span>(window)) {<br>    ...<br><br>    <span class="hljs-built_in">glBindFramebuffer</span>(GL_FRAMEBUFFER, fbo);<br>    <span class="hljs-built_in">glClearBufferfv</span>(GL_COLOR, <span class="hljs-number">0</span>, zero); <span class="hljs-comment">// {0,0,0,0}</span><br>    <span class="hljs-built_in">glClearBufferfv</span>(GL_COLOR, <span class="hljs-number">1</span>, one); <span class="hljs-comment">// {1,1,1,1}</span><br><br>    <span class="hljs-built_in">glEnable</span>(GL_BLEND);<br>    <span class="hljs-built_in">glBlendFunci</span>(<span class="hljs-number">0</span>, GL_ONE, GL_ONE); <span class="hljs-comment">// accumulation</span><br>    <span class="hljs-built_in">glBlendFunci</span>(<span class="hljs-number">1</span>, GL_ZERO, GL_ONE_MINUS_SRC_COLOR); <span class="hljs-comment">// reveal</span><br>    <span class="hljs-built_in">glBlendEquation</span>(GL_FUNC_ADD);<br><br>    <span class="hljs-built_in">glUseProgram</span>(circle);<br>    <span class="hljs-built_in">glUniform1f</span>(<span class="hljs-built_in">glGetUniformLocation</span>(circle, <span class="hljs-string">"t"</span>), (<span class="hljs-type">float</span>)<span class="hljs-built_in">glfwGetTime</span>() * <span class="hljs-number">.5</span>f);<br>    <span class="hljs-built_in">glDrawArraysInstanced</span>(GL_TRIANGLES, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">6</span>);<br><br>    ...<br>}<br><br></code></pre></td></tr></table></figure></p>
<p>circle_fsh:<br>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs glsl"><span class="hljs-meta">#version 410 core</span><br><span class="hljs-keyword">in</span> <span class="hljs-type">vec2</span> fragUV;<br><span class="hljs-keyword">in</span> <span class="hljs-type">vec4</span> fragCol;<br><br><span class="hljs-keyword">layout</span> (<span class="hljs-keyword">location</span> = <span class="hljs-number">0</span>) <span class="hljs-keyword">out</span> <span class="hljs-type">vec4</span> accum;<br><span class="hljs-keyword">layout</span> (<span class="hljs-keyword">location</span> = <span class="hljs-number">1</span>) <span class="hljs-keyword">out</span> <span class="hljs-type">float</span> reveal;<br><br><span class="hljs-type">void</span> main() {<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">length</span>(fragUV) &gt; <span class="hljs-number">0.8</span>) <span class="hljs-keyword">discard</span>;<br><br>    <span class="hljs-comment">// weight function</span><br>    <span class="hljs-type">float</span> weight = <span class="hljs-built_in">clamp</span>(<span class="hljs-built_in">pow</span>(<span class="hljs-built_in">min</span>(<span class="hljs-number">1.0</span>, fragCol.a * <span class="hljs-number">10.0</span>) + <span class="hljs-number">0.01</span>, <span class="hljs-number">3.0</span>) * <span class="hljs-number">1e8</span> * <br>                         <span class="hljs-built_in">pow</span>(<span class="hljs-number">1.0</span> - <span class="hljs-built_in">gl_FragCoord</span>.z * <span class="hljs-number">0.9</span>, <span class="hljs-number">3.0</span>), <span class="hljs-number">1e-2</span>, <span class="hljs-number">3e3</span>);<br><br>    <span class="hljs-comment">// store pixel color accumulation</span><br>    accum = <span class="hljs-type">vec4</span>(fragCol.rgb * fragCol.a, fragCol.a) * weight;<br><br>    <span class="hljs-comment">// store pixel revealage threshold</span><br>    reveal = fragCol.a;<br>}<br></code></pre></td></tr></table></figure></p>
<h2 id="叠加"><a href="#叠加" class="headerlink" title="叠加"></a>叠加</h2>
<p>经过以上的步骤，我们的任务只完成了一半。接下来是叠加。</p>
<p>首先是着色器。</p>
<p>composite_vsh:<br>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs glsl"><span class="hljs-meta">#version 410 core</span><br><span class="hljs-keyword">layout</span> (<span class="hljs-keyword">location</span> = <span class="hljs-number">0</span>) <span class="hljs-keyword">in</span> <span class="hljs-type">vec2</span> pos;<br><span class="hljs-type">void</span> main() {<br>    <span class="hljs-built_in">gl_Position</span> = <span class="hljs-type">vec4</span>(pos * <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);<br>}<br></code></pre></td></tr></table></figure></p>
<p>composite_fsh:<br>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs glsl"><span class="hljs-meta">#version 410 core</span><br><br><span class="hljs-comment">// shader outputs</span><br><span class="hljs-keyword">out</span> <span class="hljs-type">vec4</span> frag;<br><br><span class="hljs-comment">// color accumulation buffer</span><br><span class="hljs-keyword">uniform</span> <span class="hljs-type">sampler2D</span> accum;<br><br><span class="hljs-comment">// revealage threshold buffer</span><br><span class="hljs-keyword">uniform</span> <span class="hljs-type">sampler2D</span> reveal;<br><br><span class="hljs-comment">// epsilon number</span><br><span class="hljs-keyword">const</span> <span class="hljs-type">float</span> EPSILON = <span class="hljs-number">0.00001</span>f;<br><br><span class="hljs-comment">// calculate floating point numbers equality accurately</span><br><span class="hljs-type">bool</span> isApproximatelyEqual(<span class="hljs-type">float</span> a, <span class="hljs-type">float</span> b) {<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">abs</span>(a - b) &lt;= (<span class="hljs-built_in">abs</span>(a) &lt; <span class="hljs-built_in">abs</span>(b) ? <span class="hljs-built_in">abs</span>(b) : <span class="hljs-built_in">abs</span>(a)) * EPSILON;<br>}<br><br><span class="hljs-comment">// get the max value between three values</span><br><span class="hljs-type">float</span> max3(<span class="hljs-type">vec3</span> v) {<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">max</span>(<span class="hljs-built_in">max</span>(v.x, v.y), v.z);<br>}<br><br><span class="hljs-type">void</span> main() {<br>    <span class="hljs-comment">// fragment coordination</span><br>    <span class="hljs-type">ivec2</span> coords = <span class="hljs-type">ivec2</span>(<span class="hljs-built_in">gl_FragCoord</span>.xy);<br><br>    <span class="hljs-comment">// fragment revealage</span><br>    <span class="hljs-type">float</span> revealage = <span class="hljs-built_in">texelFetch</span>(reveal, coords, <span class="hljs-number">0</span>).r;<br><br>    <span class="hljs-comment">// save the blending and color texture fetch cost if there is not a transparent fragment</span><br>    <span class="hljs-keyword">if</span> (isApproximatelyEqual(revealage, <span class="hljs-number">1.0</span>f)) <span class="hljs-keyword">discard</span>;<br><br>    <span class="hljs-comment">// fragment color</span><br>    <span class="hljs-type">vec4</span> accumulation = <span class="hljs-built_in">texelFetch</span>(accum, coords, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">// suppress overflow</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isinf</span>(max3(<span class="hljs-built_in">abs</span>(accumulation.rgb))))<br>        accumulation.rgb = <span class="hljs-type">vec3</span>(accumulation.a);<br><br>    <span class="hljs-comment">// prevent floating point precision bug</span><br>    <span class="hljs-type">vec3</span> average_color = accumulation.rgb / <span class="hljs-built_in">max</span>(accumulation.a, EPSILON);<br><br>    <span class="hljs-comment">// blend pixels</span><br>    frag = <span class="hljs-type">vec4</span>(average_color, <span class="hljs-number">1.0</span>f - revealage);<br>}<br></code></pre></td></tr></table></figure></p>
<p>average_color几乎就是原来的颜色，而revealage决定这个颜色的可见性。像上面这样处理，可以保证程序在一些特殊的情况也能正常渲染。</p>
<p>编译以及绑定纹理:<br>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c++">GLuint composite = <span class="hljs-built_in">createShader</span>(composite_vsh, composite_fsh);<br><br><span class="hljs-built_in">glActiveTexture</span>(GL_TEXTURE0);<br><span class="hljs-built_in">glBindTexture</span>(GL_TEXTURE_2D, accum);<br><span class="hljs-built_in">glActiveTexture</span>(GL_TEXTURE1);<br><span class="hljs-built_in">glBindTexture</span>(GL_TEXTURE_2D, reveal);<br><br><span class="hljs-built_in">glUseProgram</span>(composite);<br><span class="hljs-built_in">glUniform1i</span>(<span class="hljs-built_in">glGetUniformLocation</span>(composite, <span class="hljs-string">"accum"</span>), <span class="hljs-number">0</span>);<br><span class="hljs-built_in">glUniform1i</span>(<span class="hljs-built_in">glGetUniformLocation</span>(composite, <span class="hljs-string">"reveal"</span>), <span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure></p>
<p>最后进行叠加渲染:<br>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">while</span> (!<span class="hljs-built_in">glfwWindowShouldClose</span>(window)) {<br>    ...<br><br>    <span class="hljs-built_in">glBindFramebuffer</span>(GL_FRAMEBUFFER, <span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">glBlendFunc</span>(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);<br><br>    <span class="hljs-built_in">glUseProgram</span>(composite);<br>    <span class="hljs-built_in">glDrawArrays</span>(GL_TRIANGLES, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>);<br><br>    <span class="hljs-built_in">glfwSwapBuffers</span>(window);<br>    <span class="hljs-built_in">glfwPollEvents</span>();<br>}<br></code></pre></td></tr></table></figure></p>
<p>你将看到如下效果:<br class='item-img' data-src='https://pic.imge.cc/2024/08/11/66b8df35768ea.gif'><img src="https://pic.imge.cc/2024/08/11/66b8df35768ea.gif"></p>
<p>完整代码，你也可以在<a target="_blank" rel="noopener" href="https://github.com/Ninter6/weighted-blended-demo">这里</a>找到:<br>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cassert&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"glad/glad.h"</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"GLFW/glfw3.h"</span></span><br><br><span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> W = <span class="hljs-number">800</span>, H = <span class="hljs-number">500</span>;<br><span class="hljs-keyword">constexpr</span> <span class="hljs-type">float</span> vert[] = { <span class="hljs-number">-.5</span>,<span class="hljs-number">-.5</span>, <span class="hljs-number">.5</span>,<span class="hljs-number">.5</span>, <span class="hljs-number">.5</span>,<span class="hljs-number">-.5</span>, <span class="hljs-number">-.5</span>,<span class="hljs-number">.5</span>, <span class="hljs-number">.5</span>,<span class="hljs-number">.5</span>, <span class="hljs-number">-.5</span>,<span class="hljs-number">-.5</span> };<br><br><span class="hljs-keyword">constexpr</span> <span class="hljs-type">float</span> zero[]{<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>}, one[]{<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>};<br><br><span class="hljs-type">float</span> proj[<span class="hljs-number">4</span>*<span class="hljs-number">4</span>]{}, _init_matrix = ([]{ <span class="hljs-comment">// NOLINT(*-reserved-identifier)</span><br>    <span class="hljs-type">float</span> aspect = (<span class="hljs-type">float</span>)W / (<span class="hljs-type">float</span>)H;<br>    <span class="hljs-type">float</span> tanHalfFov = std::<span class="hljs-built_in">tan</span>(<span class="hljs-number">.5</span>f); <span class="hljs-comment">// tan(pi/3/2)</span><br>    <span class="hljs-type">float</span> near = <span class="hljs-number">0.1f</span>, far = <span class="hljs-number">100.0f</span>;<br>    proj[<span class="hljs-number">0</span>] = <span class="hljs-number">1.0f</span> / (aspect * tanHalfFov);<br>    proj[<span class="hljs-number">5</span>] = <span class="hljs-number">1.0f</span> / tanHalfFov;<br>    proj[<span class="hljs-number">10</span>] = (far + near) / (near - far);<br>    proj[<span class="hljs-number">11</span>] =<span class="hljs-number">-1.0f</span>;<br>    proj[<span class="hljs-number">14</span>] = (<span class="hljs-number">2.0f</span> * far * near) / (near - far);<br>}(), <span class="hljs-number">0.f</span>);<br><br>GLFWwindow* window;<br><br><span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">auto</span> circle_vsh = <span class="hljs-string">R"(</span><br><span class="hljs-string">#version 410 core</span><br><span class="hljs-string">layout (location = 0) in vec2 pos;</span><br><span class="hljs-string">out vec2 fragUV;</span><br><span class="hljs-string">out vec4 fragCol;</span><br><span class="hljs-string">uniform float t;</span><br><span class="hljs-string">uniform mat4 proj;</span><br><span class="hljs-string">const vec4 colors[] = vec4[](</span><br><span class="hljs-string">    vec4(.06f, .93f, .8f, .5f),</span><br><span class="hljs-string">    vec4(1.f, .68f, .2f, .5f),</span><br><span class="hljs-string">    vec4(.37f, .83f, .09f, .5f),</span><br><span class="hljs-string">    vec4(.87f, .93f, .2f, .5f),</span><br><span class="hljs-string">    vec4(1.f, .67, .47f, .5f),</span><br><span class="hljs-string">    vec4(1.f, .37f, .4f, .5f)</span><br><span class="hljs-string">);</span><br><span class="hljs-string">void main() {</span><br><span class="hljs-string">    fragUV = pos * 2;</span><br><span class="hljs-string">    fragCol = colors[gl_InstanceID];</span><br><span class="hljs-string">    vec4 p = vec4(pos.x - sin(t + gl_InstanceID), pos.y, -3 - cos(t + gl_InstanceID), 1);</span><br><span class="hljs-string">    gl_Position = proj * p;</span><br><span class="hljs-string">})"</span>, circle_fsh = <span class="hljs-string">R"(</span><br><span class="hljs-string">#version 410 core</span><br><span class="hljs-string">in vec2 fragUV;</span><br><span class="hljs-string">in vec4 fragCol;</span><br><span class="hljs-string">layout (location = 0) out vec4 accum;</span><br><span class="hljs-string">layout (location = 1) out float reveal;</span><br><span class="hljs-string">void main() {</span><br><span class="hljs-string">    if (length(fragUV) &gt; 0.8) discard;</span><br><span class="hljs-string">    float weight = clamp(pow(min(1.0, fragCol.a * 10.0) + 0.01, 3.0) * 1e8 *</span><br><span class="hljs-string">                         pow(1.0 - gl_FragCoord.z * 0.9, 3.0), 1e-2, 3e3);</span><br><span class="hljs-string">    accum = vec4(fragCol.rgb * fragCol.a, fragCol.a) * weight;</span><br><span class="hljs-string">    reveal = fragCol.a;</span><br><span class="hljs-string">})"</span>;<br><br><span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">auto</span> homo_vsh = <span class="hljs-string">R"(</span><br><span class="hljs-string">#version 410 core</span><br><span class="hljs-string">layout (location = 0) in vec2 pos;</span><br><span class="hljs-string">vec2 scale[] = vec2[](</span><br><span class="hljs-string">    vec2(2./25., 1),</span><br><span class="hljs-string">    vec2(2./25., 1),</span><br><span class="hljs-string">    vec2(2./25., 3./5.), vec2(2./25., 1./5.), vec2(2./25., 1),</span><br><span class="hljs-string">    vec2(6./25., 1./5.), vec2(2./25., 1./5.), vec2(6./25., 1./5.), vec2(2./25., 1./5.), vec2(6./25., 1./5.),</span><br><span class="hljs-string">    vec2(2./25., 1),</span><br><span class="hljs-string">    vec2(2./25., 3./5.), vec2(2./25., 1./5.), vec2(2./25., 1)</span><br><span class="hljs-string">);</span><br><span class="hljs-string">vec2 offset[] = vec2[](</span><br><span class="hljs-string">    vec2(-16./25., 0),</span><br><span class="hljs-string">    vec2(-12./25., 0),</span><br><span class="hljs-string">    vec2(-8./25., 1./5.), vec2(-6./25., 0), vec2(-4./25., 0),</span><br><span class="hljs-string">    vec2(2./25., 2./5.), vec2(0, 1./5.), vec2(2./25., 0), vec2(4./25., -1./5.), vec2(2./25., -2./5.),</span><br><span class="hljs-string">    vec2(8./25., 0),</span><br><span class="hljs-string">    vec2(12./25., 1./5.), vec2(14./25., 0), vec2(16./25., 0)</span><br><span class="hljs-string">);</span><br><span class="hljs-string">void main() {</span><br><span class="hljs-string">    gl_Position = vec4(pos * scale[gl_InstanceID] + offset[gl_InstanceID], 0, 1);</span><br><span class="hljs-string">})"</span>, homo_fsh = <span class="hljs-string">R"(</span><br><span class="hljs-string">#version 410 core</span><br><span class="hljs-string">out vec4 color;</span><br><span class="hljs-string">void main() { color = vec4(1, 0.333, 0, 1); }</span><br><span class="hljs-string">)"</span>;<br><br><span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">auto</span> composite_vsh = <span class="hljs-string">R"(</span><br><span class="hljs-string">#version 410 core</span><br><span class="hljs-string">layout (location = 0) in vec2 pos;</span><br><span class="hljs-string">void main() { gl_Position = vec4(pos * 2, 0, 1); }</span><br><span class="hljs-string">)"</span>, composite_fsh = <span class="hljs-string">R"(</span><br><span class="hljs-string">#version 410 core</span><br><span class="hljs-string">out vec4 frag;</span><br><span class="hljs-string">uniform sampler2D accum;</span><br><span class="hljs-string">uniform sampler2D reveal;</span><br><span class="hljs-string">const float EPSILON = 0.00001f;</span><br><span class="hljs-string">bool isApproximatelyEqual(float a, float b) {</span><br><span class="hljs-string">    return abs(a - b) &lt;= (abs(a) &lt; abs(b) ? abs(b) : abs(a)) * EPSILON;</span><br><span class="hljs-string">}</span><br><span class="hljs-string">float max3(vec3 v) { return max(max(v.x, v.y), v.z); }</span><br><span class="hljs-string">void main() {</span><br><span class="hljs-string">    ivec2 coords = ivec2(gl_FragCoord.xy);</span><br><span class="hljs-string">    float revealage = texelFetch(reveal, coords, 0).r;</span><br><span class="hljs-string">    if (isApproximatelyEqual(revealage, 1.0f)) discard;</span><br><span class="hljs-string">    vec4 accumulation = texelFetch(accum, coords, 0);</span><br><span class="hljs-string">    if (isinf(max3(abs(accumulation.rgb)))) accumulation.rgb = vec3(accumulation.a);</span><br><span class="hljs-string">    vec3 average_color = accumulation.rgb / max(accumulation.a, EPSILON);</span><br><span class="hljs-string">    frag = vec4(average_color, 1.0f - revealage);</span><br><span class="hljs-string">})"</span>;<br><br><span class="hljs-function">GLuint <span class="hljs-title">createShader</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* vsh, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* fsh)</span> </span>{<br>    GLuint vertexShader = <span class="hljs-built_in">glCreateShader</span>(GL_VERTEX_SHADER);<br>    <span class="hljs-built_in">glShaderSource</span>(vertexShader, <span class="hljs-number">1</span>, &amp;vsh, <span class="hljs-literal">nullptr</span>);<br>    <span class="hljs-built_in">glCompileShader</span>(vertexShader);<br><br>    GLuint fragmentShader = <span class="hljs-built_in">glCreateShader</span>(GL_FRAGMENT_SHADER);<br>    <span class="hljs-built_in">glShaderSource</span>(fragmentShader, <span class="hljs-number">1</span>, &amp;fsh, <span class="hljs-literal">nullptr</span>);<br>    <span class="hljs-built_in">glCompileShader</span>(fragmentShader);<br><br>    GLuint program = <span class="hljs-built_in">glCreateProgram</span>();<br>    <span class="hljs-built_in">glAttachShader</span>(program, vertexShader);<br>    <span class="hljs-built_in">glAttachShader</span>(program, fragmentShader);<br>    <span class="hljs-built_in">glLinkProgram</span>(program);<br><br>    GLint success;<br>    <span class="hljs-built_in">glGetProgramiv</span>(program, GL_LINK_STATUS, &amp;success);<br>    <span class="hljs-keyword">if</span>(!success) {<br>        GLint length;<br>        <span class="hljs-built_in">glGetProgramiv</span>(program, GL_INFO_LOG_LENGTH, &amp;length);<br>        <span class="hljs-function">std::string <span class="hljs-title">infoLog</span><span class="hljs-params">(<span class="hljs-string">"\0"</span>, length)</span></span>;<br>        <span class="hljs-built_in">glGetProgramInfoLog</span>(program, <span class="hljs-number">512</span>, <span class="hljs-literal">nullptr</span>, infoLog.<span class="hljs-built_in">data</span>());<br>        <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"Failed to link shader:\n"</span> + infoLog);<br>    }<br><br>    <span class="hljs-built_in">glDeleteShader</span>(vertexShader);<br>    <span class="hljs-built_in">glDeleteShader</span>(fragmentShader);<br><br>    <span class="hljs-keyword">return</span> program;<br>}<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">glfwInit</span>() == GLFW_FALSE)<br>        <span class="hljs-built_in">assert</span>(<span class="hljs-literal">false</span> &amp;&amp; <span class="hljs-string">"failed to initialize GLFW"</span>);<br>    <span class="hljs-built_in">glfwWindowHint</span>(GLFW_CONTEXT_VERSION_MAJOR, <span class="hljs-number">4</span>);<br>    <span class="hljs-built_in">glfwWindowHint</span>(GLFW_CONTEXT_VERSION_MINOR, <span class="hljs-number">1</span>);<br>    <span class="hljs-built_in">glfwWindowHint</span>(GLFW_OPENGL_PROFILE, GLFW_OPENGL_CORE_PROFILE);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> __APPLE__</span><br>    <span class="hljs-built_in">glfwWindowHint</span>(GLFW_OPENGL_FORWARD_COMPAT, GL_TRUE);<br>    window = <span class="hljs-built_in">glfwCreateWindow</span>(W/<span class="hljs-number">2</span>, H/<span class="hljs-number">2</span>, <span class="hljs-string">"weighted blended"</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    window = <span class="hljs-built_in">glfwCreateWindow</span>(W, H, <span class="hljs-string">"weighted blended"</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-built_in">assert</span>(window &amp;&amp; <span class="hljs-string">"failed to create window"</span>);<br><br>    <span class="hljs-built_in">glfwMakeContextCurrent</span>(window);<br><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">gladLoadGLLoader</span>((GLADloadproc)glfwGetProcAddress))<br>        <span class="hljs-built_in">assert</span>(<span class="hljs-literal">false</span> &amp;&amp; <span class="hljs-string">"failed to initialize GLAD"</span>);<br><br>    <span class="hljs-built_in">glEnable</span>(GL_BLEND);<br>    <span class="hljs-built_in">glBlendFunc</span>(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);<br><br>    <span class="hljs-built_in">glViewport</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, W, H);<br><br>    GLuint circle = <span class="hljs-built_in">createShader</span>(circle_vsh, circle_fsh),<br>           homo = <span class="hljs-built_in">createShader</span>(homo_vsh, homo_fsh),<br>           composite = <span class="hljs-built_in">createShader</span>(composite_vsh, composite_fsh);<br>    <span class="hljs-built_in">glUseProgram</span>(circle);<br>    <span class="hljs-built_in">glUniformMatrix4fv</span>(<span class="hljs-built_in">glGetUniformLocation</span>(circle, <span class="hljs-string">"proj"</span>), <span class="hljs-number">1</span>, GL_FALSE, proj);<br><br>    <span class="hljs-built_in">glUseProgram</span>(composite);<br>    <span class="hljs-built_in">glUniform1i</span>(<span class="hljs-built_in">glGetUniformLocation</span>(composite, <span class="hljs-string">"accum"</span>), <span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">glUniform1i</span>(<span class="hljs-built_in">glGetUniformLocation</span>(composite, <span class="hljs-string">"reveal"</span>), <span class="hljs-number">1</span>);<br><br>    GLuint vao, vbo;<br>    <span class="hljs-built_in">glGenVertexArrays</span>(<span class="hljs-number">1</span>, &amp;vao);<br>    <span class="hljs-built_in">glBindVertexArray</span>(vao);<br>    <span class="hljs-built_in">glGenBuffers</span>(<span class="hljs-number">1</span>, &amp;vbo);<br>    <span class="hljs-built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, vbo);<br>    <span class="hljs-built_in">glBufferData</span>(GL_ARRAY_BUFFER, <span class="hljs-built_in">sizeof</span>(vert), vert, GL_STATIC_DRAW);<br>    <span class="hljs-built_in">glVertexAttribPointer</span>(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, GL_FLOAT, GL_FALSE, <span class="hljs-number">2</span> * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>), <span class="hljs-literal">nullptr</span>);<br>    <span class="hljs-built_in">glEnableVertexAttribArray</span>(<span class="hljs-number">0</span>);<br><br>    GLuint fbo;<br>    <span class="hljs-built_in">glGenFramebuffers</span>(<span class="hljs-number">1</span>, &amp;fbo);<br>    <span class="hljs-built_in">glBindFramebuffer</span>(GL_FRAMEBUFFER, fbo);<br><br>    GLuint accum, reveal;<br>    <span class="hljs-built_in">glGenTextures</span>(<span class="hljs-number">1</span>, &amp;accum);<br>    <span class="hljs-built_in">glActiveTexture</span>(GL_TEXTURE0);<br>    <span class="hljs-built_in">glBindTexture</span>(GL_TEXTURE_2D, accum);<br>    <span class="hljs-built_in">glTexImage2D</span>(GL_TEXTURE_2D, <span class="hljs-number">0</span>, GL_RGBA16F, W, H, <span class="hljs-number">0</span>, GL_RGBA, GL_HALF_FLOAT, <span class="hljs-literal">nullptr</span>);<br>    <span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);<br>    <span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);<br>    <span class="hljs-built_in">glGenTextures</span>(<span class="hljs-number">1</span>, &amp;reveal);<br>    <span class="hljs-built_in">glActiveTexture</span>(GL_TEXTURE1);<br>    <span class="hljs-built_in">glBindTexture</span>(GL_TEXTURE_2D, reveal);<br>    <span class="hljs-built_in">glTexImage2D</span>(GL_TEXTURE_2D, <span class="hljs-number">0</span>, GL_R8, W, H, <span class="hljs-number">0</span>, GL_RED, GL_FLOAT, <span class="hljs-literal">nullptr</span>);<br>    <span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);<br>    <span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);<br><br>    <span class="hljs-built_in">glFramebufferTexture2D</span>(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D, accum, <span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">glFramebufferTexture2D</span>(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENT1, GL_TEXTURE_2D, reveal, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">constexpr</span> GLenum attachments[] = { GL_COLOR_ATTACHMENT0, GL_COLOR_ATTACHMENT1 };<br>    <span class="hljs-built_in">glDrawBuffers</span>(<span class="hljs-number">2</span>, attachments);<br><br>    <span class="hljs-keyword">while</span> (!<span class="hljs-built_in">glfwWindowShouldClose</span>(window)) {<br>        <span class="hljs-built_in">glBindFramebuffer</span>(GL_FRAMEBUFFER, <span class="hljs-number">0</span>);<br>        <span class="hljs-built_in">glClearColor</span>(<span class="hljs-number">0.2f</span>, <span class="hljs-number">0.3f</span>, <span class="hljs-number">0.3f</span>, <span class="hljs-number">1.0f</span>);<br>        <span class="hljs-built_in">glClear</span>(GL_COLOR_BUFFER_BIT);<br><br>        <span class="hljs-built_in">glDisable</span>(GL_BLEND);<br>        <span class="hljs-built_in">glUseProgram</span>(homo);<br>        <span class="hljs-built_in">glDrawArraysInstanced</span>(GL_TRIANGLES, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">14</span>);<br><br>        <span class="hljs-built_in">glBindFramebuffer</span>(GL_FRAMEBUFFER, fbo);<br>        <span class="hljs-built_in">glClearBufferfv</span>(GL_COLOR, <span class="hljs-number">0</span>, zero); <span class="hljs-comment">// {0,0,0,0}</span><br>        <span class="hljs-built_in">glClearBufferfv</span>(GL_COLOR, <span class="hljs-number">1</span>, one); <span class="hljs-comment">// {1,1,1,1}</span><br><br>        <span class="hljs-built_in">glEnable</span>(GL_BLEND);<br>        <span class="hljs-built_in">glBlendFunci</span>(<span class="hljs-number">0</span>, GL_ONE, GL_ONE); <span class="hljs-comment">// accumulation</span><br>        <span class="hljs-built_in">glBlendFunci</span>(<span class="hljs-number">1</span>, GL_ZERO, GL_ONE_MINUS_SRC_COLOR); <span class="hljs-comment">// reveal</span><br>        <span class="hljs-built_in">glBlendEquation</span>(GL_FUNC_ADD);<br><br>        <span class="hljs-built_in">glUseProgram</span>(circle);<br>        <span class="hljs-built_in">glUniform1f</span>(<span class="hljs-built_in">glGetUniformLocation</span>(circle, <span class="hljs-string">"t"</span>), (<span class="hljs-type">float</span>)<span class="hljs-built_in">glfwGetTime</span>() * <span class="hljs-number">.5</span>f);<br>        <span class="hljs-built_in">glDrawArraysInstanced</span>(GL_TRIANGLES, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">6</span>);<br><br>        <span class="hljs-built_in">glBindFramebuffer</span>(GL_FRAMEBUFFER, <span class="hljs-number">0</span>);<br>        <span class="hljs-built_in">glBlendFunc</span>(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);<br><br>        <span class="hljs-built_in">glUseProgram</span>(composite);<br>        <span class="hljs-built_in">glDrawArrays</span>(GL_TRIANGLES, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>);<br><br>        <span class="hljs-built_in">glfwSwapBuffers</span>(window);<br>        <span class="hljs-built_in">glfwPollEvents</span>();<br>    }<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></code></pre></td></tr></table></figure></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2024/08/22/%E7%8B%97%E5%A4%B4%E5%9C%88%E7%9A%84%E6%89%80%E6%9C%89%E7%BB%93%E5%B1%80/">← 下一篇 狗头圈的所有结局</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2024/06/21/%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AAJson%E8%A7%A3%E6%9E%90%E5%99%A8/">编写一个JSON解析器「C++」 上一篇 →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="回到顶部" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="文章目录">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="切换主题"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">Dr. Ninter6</a></h1><div id="description"><p></p></div><div id="social-links"><a class="social" target="_blank" rel="noopener" href="https://github.com/Ninter6"><i class="fab fa-github" alt="GitHub"></i></a></div></div><div id="aside-block"><div id="toc-div"><h1>目录</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#weighted-blended"><span class="toc-number">1.</span> <span class="toc-text">Weighted Blended</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%84%E8%A7%88"><span class="toc-number">1.2.</span> <span class="toc-text">预览</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%B8%A7%E7%BC%93%E5%86%B2"><span class="toc-number">1.3.</span> <span class="toc-text">创建帧缓冲</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%B2%E6%9F%93%E4%B8%8D%E9%80%8F%E6%98%8E%E7%89%A9%E4%BD%93"><span class="toc-number">1.4.</span> <span class="toc-text">渲染不透明物体</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%B2%E6%9F%93%E9%80%8F%E6%98%8E%E7%89%A9%E4%BD%93"><span class="toc-number">1.5.</span> <span class="toc-text">渲染透明物体</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%A0%E5%8A%A0"><span class="toc-number">1.6.</span> <span class="toc-text">叠加</span></a></li></ol></li></ol></div></div><footer><nobr><span class="icp-title">©️</span><span class="icp-content">Ninter Z</span></nobr><br><nobr>构建自 <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> 使用主题 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> 主题作者 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas></body></html>